<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Retrieve-Mapper">

	<sql id="search">
		<if test="searchType == 'C'.toString()">
		<![CDATA[
			and a.product_date < SYSDATE
		]]>
		</if>
		and b.md_name like '%'||#{keyword}||'%'

	</sql>

	<!-- 로그인한 사용자의 근무 약국에서 가지고 있는 재고 목록 -->
	<select id="selectRetrieveProductList" resultType="product">
		select
		a.product_qr
		,a.pharmacy_code
		,a.md_no
		,a.product_ownnum
		,a.product_unit
		,a.product_ownnum_standard
		,a.product_date
		,a.product_update_date
		,b.md_name
		from product a, medicine b,
		medicine_info c
		where a.product_qr is not null
		and a.md_no = b.md_no
		and
		b.mi_code = c.mi_code
		and a.pharmacy_code = #{pharmacyCode}
		<include refid="search" />
		order by a.product_update_date DESC
	</select>

	<!-- 페이지네이션을 위한 재고 수 -->
	<select id="selectSearchRetrieveProductListCount"
		resultType="int">
		select count(*)
		from product a, medicine b, medicine_info c
		where
		a.product_qr is not null
		and a.md_no = b.md_no
		and b.mi_code = c.mi_code
		and a.pharmacy_code = #{pharmacyCode}
		<include refid="search" />
		order by a.md_no ASC
	</select>

	<!-- #{retrieveNo} -->
	<update id="insertRetrieve" parameterType="retrieve">
		INSERT INTO retrieve (
		retrieve_no
		,chemist_code
		,pharmacy_code
		,retrieve_date
		) VALUES (
		#{retrieveNo}
		,#{chemistCode}
		,#{pharmacyCode}
		,sysdate
		)
	</update>



	<update id="insertRetrieveList">
		INSERT INTO retrieve_list (
		RETRIEVE_LIST_NO
		,retrieve_no
		,rl_name
		,rl_code
		,rl_reason
		,rl_num
		,rl_qr
		,mi_unit
		) VALUES (
		RETRIEVE_List_SEQ.NEXTVAL
		,#{retrieveNo}
		,#{rlName}
		,#{rlCode}
		,#{rlReason}
		,#{rlNum}
		,#{rlQr}
		,#{miUnit}
		)
	</update>

	<select id="selectRetrieveNo" resultType="int">
		select
		RETRIEVE_SEQ.NEXTVAL
		from dual
	</select>

	<select id="selectMaxRetrieveNo" resultType="int">
		select
		max(RETRIEVE_NO)
		from retrieve
	</select>

	<update id="updateProductNum">

		UPDATE product
		SET
		product_ownnum = (select
		product_ownnum
		from product
		where product_qr = #{rlQr}) - #{rlNum}
		WHERE
		product_qr =#{rlQr}
	</update>

	<update id="zeroProductDelete">
		DELETE
		FROM product
		WHERE (select PRODUCT_OWNNUM
		from
		product
		where PRODUCT_QR = #{rlQr}) = 0
	</update>



	<sql id="retrieveSearch">

		<if test="startDate != null and endDate != null">
			and b.retrieve_date between to_date(#{startDate},'YYYY-MM-DD') and
			to_date(#{endDate},'YYYY-MM-DD') + INTERVAL '1' day
		</if>
		<!-- and b.retrieve_date between to_date('#{startDate}') and to_date('#{endDate}') -->
		and b.RETRIEVE_NO in (select d.RETRIEVE_NO
		from RETRIEVE_LIST c,
		retrieve d
		where c.RETRIEVE_NO = d.RETRIEVE_NO
		and c.RL_NAME like
		'%'||#{keyword}||'%')
	</sql>

	<!-- 로그인한 사용자의 근무 약국 회수내역 -->
	<select id="selectRetrieveList" resultType="retrieveCommand">
		SELECT
		b.retrieve_no
		,b.chemist_code
		,b.pharmacy_code
		,b.retrieve_date
		,(select a.RL_NAME
		from RETRIEVE_LIST a
		where a.RETRIEVE_NO =
		b.RETRIEVE_NO
		and ROWNUM = 1) as rlName
		,(select count(*)
		from
		RETRIEVE_LIST a
		where a.RETRIEVE_NO = b.RETRIEVE_NO) as rlCount
		,(select MEM_NAME
		from MEMBER d
		where (select c.MEM_ID
		from CHEMIST c
		where b.chemist_code = c.CHEMIST_CODE) = d.mem_id) as memName
		FROM
		retrieve b
		where retrieve_no is not null
		<include refid="retrieveSearch" />
		order by b.retrieve_date DESC
	</select>

	<!-- 페이지네이션을 위한 회수 내역 수 -->
	<select id="selectSearchRetrieveListCount" resultType="int">
		select count(DISTINCT b.retrieve_no)
		from retrieve b, RETRIEVE_LIST a
		where b.retrieve_no is not null
		and b.pharmacy_code = #{pharmacyCode}
		and a.RETRIEVE_NO = b.RETRIEVE_NO
		<include refid="retrieveSearch" />
		order by b.retrieve_no ASC
	</select>

	<!-- 목록에서 선택한 요소의 상세 가져오기 -->
	<select id="selectRetrieveListDetail" resultType="RetrieveList">
		SELECT
		retrieve_no
		,rl_name
		,rl_code
		,rl_reason
		,rl_num
		,rl_qr
		,mi_unit
		,retrieve_list_no
		FROM
		retrieve_list
		where retrieve_no = #{retrieveNo}
	</select>

</mapper>


